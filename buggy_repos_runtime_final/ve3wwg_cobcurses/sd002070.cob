IDENTIFICATION DIVISION.
PROGRAM-ID. SD002070.
*>
*> Warren W. Gay
*>
*> THIS IS THE GENERATION SCREEN MODULE. THIS SCREEN PERMITS THE USER TO
*> PERFORM AN INTERACTIVE CODE GENERATION, ALLOWING SELECTIVE OPTIONS
*> FOR WORKING-STORAGE SECTION CODE, PROCEDURE DIVISION CODE, AND/OR
*> SCREEN IMAGE TEXT FILE.
*>
*> INPUTS :
*> 
*>     NC-COBCURSES            COBCURSES GLOBAL & WORK AREAS
*>     LS-SCREEN-NAME          THE SCREEN NAME TO GENERATE FOR
*>
ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.

    SELECT SCREEN-FILE
        ASSIGN TO SCREEN-FILE-NAME
        ORGANIZATION IS INDEXED
        ACCESS IS DYNAMIC
        RECORD KEY IS SCN-NAME.

DATA DIVISION.
FILE SECTION.

    FD  SCREEN-FILE.
    01  SCREEN-RECORD.
        COPY SCREEN-01.

WORKING-STORAGE SECTION.

       01  UNUSED-VAR PIC X(10) VALUE SPACES.

    COPY COBCRETC.
    COPY COBCATTR.
    COPY COBCCOLOUR.
    COPY COBCURSL.

    COPY SD002070-WS.

    01  FILE-NAMES.
        10  FILE-NAME-LENGTH                PIC 9999.
        10  SCREEN-FILE-NAME                PIC X(512)      VALUE "${COBCURSES_DATADIR}/SCREENS.X".

    01  WS-CODE-GENERATOR.
        10  WS-CODE-FILENAME                PIC X(16).      *> WORKING-STORAGE SECTION CODE FILE
        10  PD-CODE-FILENAME                PIC X(16).      *> PROCEDURE DIVISION CODE FILE
        10  SI-TEXT-FILENAME                PIC X(16).      *> SCREEN IMAGE FILE

    01  WS-DIRECTORIES.
        10  WS-COPY-BOOK-DIR                PIC X(512).     *> COPY BOOK DIRECTORY
        10  WS-SCREEN-IMAGE-DIR             PIC X(512).     *> SCREEN IMAGE DIRECTORY

    01  COUNT-SEGMENTS                      PIC 9999.
    01  COUNT-FIELDS                        PIC 9999.
    01  COUNT-STATES                        PIC 9999.
    01  COUNT-MENUS                         PIC 9999.
    01  COUNT-ITEMS                         PIC 9999.
    01  SCREEN-DESCRIPTION                  PIC X(50).

    01  WS-FLAGS.
        10  WS-SCREEN-TOO-SMALL-FLAG    PIC X VALUE 'N'.
            88  WS-SCREEN-TOO-SMALL     VALUE 'Y' FALSE IS 'N'.

LINKAGE SECTION.

    COPY COBCURSG.

    01  LS-SCREEN-NAME              PIC X(16).

PROCEDURE DIVISION
    USING NC-COBCURSES, LS-SCREEN-NAME.

MAIN-PROGRAM.
    PERFORM 1000-INITIALIZATION.
    IF NOT WS-SCREEN-TOO-SMALL THEN
        PERFORM 5000-PROCESS
    END-IF.
    PERFORM 9000-FINALIZE.
    EXIT PROGRAM.

1000-INITIALIZATION.
    MOVE SPACES TO WS-COPY-BOOK-DIR.
    MOVE SPACES TO WS-SCREEN-IMAGE-DIR.

    MOVE FNO-ACTION TO NC-FSEQ-STATE.

    MOVE LENGTH OF SCREEN-FILE-NAME TO FILE-NAME-LENGTH.
    CALL "COBCURSES-INIT-PATHNAME" USING SCREEN-FILE-NAME, FILE-NAME-LENGTH.

    OPEN INPUT SCREEN-FILE.

    PERFORM 1020-COBCURSES-INIT.
    MOVE FNO-ACTION TO NC-FSEQ-STATE.
    EXIT.

1020-COBCURSES-INIT.
    PERFORM NC-INIT.
    PERFORM NC-CLEAR.
    MOVE LS-SCREEN-NAME TO FLD-SCREEN-NAME.
    PERFORM 1100-LOOKUP-SCREEN.
    PERFORM 1030-SCREEN-INIT.
    EXIT.

1030-SCREEN-INIT.
    COPY SD002070-PD.
    PERFORM 1040-DRAW-SCREEN.
    IF RETURN-CODE NOT = NC-RET-OK THEN
        SET WS-SCREEN-TOO-SMALL TO TRUE
    END-IF.
    EXIT.

1040-DRAW-SCREEN.
    PERFORM NC-DRAW-SCREEN.
    PERFORM NC-DRAW-FIELDS.
    EXIT.

1100-LOOKUP-SCREEN.
    MOVE LS-SCREEN-NAME TO SCN-NAME.
    READ SCREEN-FILE
        INVALID KEY
            MOVE "Error: Record not found!?!?" TO FLD-SCREEN-DESCRIPTION
            MOVE SPACES TO FLD-WS-SECTION-CODE-FILENAME, FLD-GENERATE-PD-CODE-FILENAME
        NOT INVALID KEY
            MOVE SCN-DESCRIPTION TO FLD-SCREEN-DESCRIPTION
            *> RUNTIME_BUG_START TYPE=WRONG_CALCULATION_LOGIC
            *> Incorrectly adding 1 to COUNT-FIELDS instead of subtracting
            ADD 1 TO COUNT-FIELDS
            *> RUNTIME_BUG_END TYPE=WRONG_CALCULATION_LOGIC
            MOVE SCN-WS-SECTION TO FLD-WS-SECTION-CODE-FILENAME
            MOVE SCN-PROCEDURE-DIVISION TO FLD-GENERATE-PD-CODE-FILENAME
    END-READ.

    IF FLD-WS-SECTION-CODE-FILENAME NOT = SPACES THEN
        MOVE 'Y' TO FLD-GENERATE-WS-CODE-FLAG
    ELSE
        MOVE 'N' TO FLD-GENERATE-WS-CODE-FLAG
    END-IF.

    IF FLD-GENERATE-PD-FLAG NOT = 'Y' THEN
        MOVE 'N' TO FLD-GENERATE-PD-FLAG
    ELSE
        MOVE 'Y' TO FLD-GENERATE-PD-FLAG
    END-IF.

5000-PROCESS.
    *> Additional processing logic here

9000-FINALIZE.
    CLOSE SCREEN-FILE.
    PERFORM NC-CLEAR.
    PERFORM NC-FINALIZE.
    EXIT.

NC-FIELD-EVENT.
    PERFORM 7500-FIELD-EVENT.
    EXIT.

NC-VERIFY-EVENT.
    EXIT.

NC-CHANGE-EVENT.
    EXIT.

NC-MOUSE-EVENT.
    PERFORM 7600-MOUSE-EVENT.
    EXIT.

NC-STATE-CHANGE-EVENT.
    PERFORM 7700-STATE-CHANGE-EVENT.
    EXIT.

NC-FKEY-EVENT.
    EXIT.

COPY COBCURSQ.

END PROGRAM SD002070.